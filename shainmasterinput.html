<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>社員マスタ入力</title>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=viewport content="width=device-width,initial-scale=1">

    <!--
    bulma
    https://bulma.io/

    form基本
    https://bulma.io/documentation/form/general/

    columns (grid)システム(is-0 ～ is-12)
    https://bulma.io/documentation/columns/sizes/
    https://bulma.io/documentation/columns/gap/

    メッセージ
    https://bulma.io/documentation/components/message/
    ボタン(色)
    https://bulma.io/documentation/modifiers/syntax/
    https://bulma.io/documentation/elements/button/

    元
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    -->

    <link rel="stylesheet" href="./css/bulma.min.css">
    <!--
        fa-××のアイコン
        https://bulma.io/documentation/elements/icon/ ⇒ https://fontawesome.com/ ⇒ https://fontawesome.com/icons?d=gallery&q=search&m=free

        ※こちらのコンポーネント直リンクしないとアイコンでない
    -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

    <!-- Vue.js
        https://npmcdn.com/vue/dist/vue.js
        https://unpkg.com/vue@2.4.0/dist/vue.js

        元
        <script src="https://npmcdn.com/vue/dist/vue.js"></script>
    -->
    <script src="./javascript/vue.js"></script>


    <!-- プロジェクト用 -->
    <!-- enterキー移動 -->
    <script src="./javascript/focus.js"></script>
    <!-- バリデーション -->
    <script src="./javascript/project.js"></script>

    <!-- vue拡張 -->
    <script src="./javascript/doracomponent.js"></script>

    <link rel="stylesheet" href="./css/project.css">

</head>
<body>
    <!--
    <div class="loading"></div>
-->
    <div id="app">
        <!-- マスタページっぽいもの -->
        <div class="columns">
            <div class="column" style="margin-top:10px">
                <span class="icon" onclick="window.top.location.href = 'menu.html';">
                    <i class="fas fa-home"></i>
                </span>
                サンプルシステム（固定ページ）
            </div>
        </div>

        <div class="columns">
            <div class="column">
                <article class="message is-primary">
                    <div class="message-header">
                        <p>入力</p>
                        <span class="icon">
                            <i class="fas fa-edit"></i>
                        </span>
                    </div>
                    <div class="message-body">  
                        <button class="button is-primary" v-on:click="submit(false)">更新</button>
                        <button class="button is-primary" v-on:click="submit(true)">【テスト】更新(サーバチェックエラー)</button>

                        <button class="button is-danger" v-on:click="clear()">クリア</button>
                        <button class="button is-warning" v-on:click="remove()">削除</button>
                        &nbsp;
                        <button class="button is-success" v-on:click="returnpage()">戻る</button>

                        <div class="column is-offset-2 is-8" v-for="(elem, elemIndex) in bindItems">

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">社員コード</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!-- 新規の場合しか入力不可(isprimarykey="true" & NEW_FLAG=trueの場合 ⇒ project.js Project.SetControlCss で処理) -->
                                            <!--
                                            バリデーション 半角入力 5桁(minlengthvalue="5"  maxlengthvalue="5")  textalignはproject.jsで処理(本来はclass に直接記述する事推奨)
                                            -->
                                            <input v-model.lazy="elem.社員コード" v-dora_updateflag="elem" class="input" isime="false" isprimarykey="true" ishankaku="true" minlengthvalue="5"  maxlengthvalue="5" textalign="center" />
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">社員名</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!-- バリデーション ～10桁  isime(project.jsで処理) -->
                                            <input v-model.lazy="elem.社員名" v-dora_updateflag="elem" isime="true" maxlengthvalue="10" class="input" />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">入社年月日</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!-- フォーマットが入っているものは自動的に imeoff -->
                                            <input v-model.lazy="elem.入社年月日" v-dora_updateflag="elem" dora_format="yyyy/MM/dd" class="input" />
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">性別</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <span v-for="option in seibetuType">
                                                <input type="radio" v-bind:id="['optSeibetu' + elemIndex + '_' + option.value]" v-bind:value="option.value" v-dora_updateflag="elem" v-model="elem.性別区分" class="radio">
                                                <label v-bind:for="['optSeibetu' + elemIndex + '_' + option.value]">{{option.text}}</label>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">扶養家族</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!-- checkbox複数(ラベルチェック時にONにする処理不要であれば v-bind:id v-bind:for の処理は削除可) -->
                                            <span v-for="option in fuyokazokuType">
                                                <input type="checkbox" v-model.lazy="elem.扶養家族区分" v-dora_updateflag="elem" v-bind:id="['chkFuyo' + elemIndex + '_' + option.value]" v-bind:value="option.value" class="checkbox">
                                                <label v-bind:for="['chkFuyo' + elemIndex + '_' + option.value]">{{option.text}}</label>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">都道府県</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <div class="select">
                                                <select v-model.lazy="elem.都道府県CD" v-dora_updateflag="elem" v-dora_selectitems.once="todofukenItems" dora_blanktext="(選択なし)" v-on:change="changeTodofuken(elem)"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">市区町村</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!--都道府県により変更-->
                                            <div class="select">
                                                <select v-model.lazy="elem.市区町村CD" v-dora_updateflag="elem" v-dora_selectitems="getShikuchoson(elem.都道府県CD)" dora_blanktext="(選択なし)" v-on:change="changeShikuchoson(elem)"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">町域</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!--都道府県、市区町村により変更-->
                                            <div class="select">
                                                <select v-model.lazy="elem.町域CD" v-dora_updateflag="elem" v-dora_selectitems="getChoiki(elem.都道府県CD,elem.市区町村CD)" dora_blanktext="(選択なし)"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-horizontal">
                                <div class="field-label is-normal">
                                    <label class="label">住所</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <!-- バリデーション ～20桁  imeON(project.jsで処理) -->
                                            <input v-model.lazy="elem.住所" v-dora_updateflag="elem" isime="true" maxlengthvalue="20" class="input" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        'use strict';

        var vm = new Vue({
            el: '#app',
            created: function () {
                //domが絡む場合はmountedを初期にしたほうがよい
            }
            ,
            mounted: function () {
                let self = this;        //ieを考慮する場合、アロー関数(()=>)が使えないのでこちらの書き方推奨
                //json get data
                var xmlHttpRequest = new XMLHttpRequest();
                xmlHttpRequest.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        if (this.response) {
                            //データのセット
                            let mainItems;
                            if (typeof this.response == 'object') {
                                mainItems = this.response;
                            }
                            else {
                                mainItems = JSON.parse(this.response);
                            }

                            //都道府県
                            let appendList = new Set();

                            for (let item in mainItems) {

                                if (appendList.has(mainItems[item].都道府県CD) == false) {

                                    //追加
                                    appendList.add(mainItems[item].都道府県CD);

                                    self.todofukenItems.push({
                                        value: mainItems[item].都道府県CD,
                                        text: mainItems[item].都道府県,
                                    });

                                }
                            }

                            //sort
                            self.todofukenItems.sort(
                                function (a, b) {
                                    if (a.value < b.value) { return -1; }
                                    else if (a.value > b.value) { return 1; }
                                    return 0;
                                }
                                );

                            //市区町村
                            appendList = new Set();
                            for (let item in mainItems) {

                                if (appendList.has(mainItems[item].市区町村CD) == false) {

                                    //追加
                                    appendList.add(mainItems[item].市区町村CD);

                                    self.shikuchosonItems.push({
                                        都道府県CD: mainItems[item].都道府県CD,
                                        value: mainItems[item].市区町村CD,
                                        text: mainItems[item].市区町村,
                                    });

                                }
                            }

                            //sort
                            self.shikuchosonItems.sort(
                                function (a, b) {
                                    if (a.value < b.value) { return -1; }
                                    else if (a.value > b.value) { return 1; }
                                    return 0;
                                }
                                );


                            //町域
                            appendList = new Set();
                            for (let item in mainItems) {

                                if (mainItems[item].町域CD && appendList.has(mainItems[item].町域CD) == false) {

                                    //追加
                                    appendList.add(mainItems[item].町域CD);

                                    self.choikiItems.push({
                                        都道府県CD: mainItems[item].都道府県CD,
                                        市区町村CD: mainItems[item].市区町村CD,
                                        value: mainItems[item].町域CD,
                                        text: mainItems[item].町域 ? mainItems[item].町域 : '(該当なし)',
                                    });

                                }
                            }

                            //sort
                            self.choikiItems.sort(
                                function (a, b) {
                                    if (a.value < b.value) { return -1; }
                                    else if (a.value > b.value) { return 1; }
                                    return 0;
                                }
                                );


                        }
                    }
                }

                xmlHttpRequest.open('GET', '/chugoku.json', true);
                xmlHttpRequest.responseType = 'json';
                xmlHttpRequest.send(null);

                this.clear();
            }
            ,
            data: {

                bindItems: [],      //バインド用

                //性別区分
                seibetuType: [
                                {
                                    value: 1,
                                    text: '男性'
                                },
                                {
                                    value: 2,
                                    text: '女性'
                                },

                ],

                //扶養家族区分（複数選択）
                fuyokazokuType: [
                                {
                                    value: 1,
                                    text: '配偶者'
                                },
                                {
                                    value: 2,
                                    text: '第一子'
                                },
                                {
                                    value: 3,
                                    text: '第二子'
                                },
                                {
                                    value: 4,
                                    text: '第三子'
                                },

                ],

                todofukenItems: [],     //都道府県コンボ用
                shikuchosonItems: [],   //市区町村コンボ用
                choikiItems: [],        //町域コンボ用


            },
            methods: {

                submit: function (testFlag) {       //引数testFlagは必要なし
                    
                    Project.SetLoading(true);   //２度押し防止用くるくる（開始）

                    try{
                        let self = this;        //ieを考慮する場合、アロー関数(()=>)が使えないのでこちらの書き方推奨

                        if (
                            //こちらの関数内でIDENTITYをセット
                            Project.IsSubmitValidateError(
                                this.bindItems,
                                ['社員コード'],
                                ['社員コード', '社員名'],
                            //個別チェック
                                function (paraError, paraItem) {
                            //都道府県を入力した場合に市区町村CDが入力されていない場合
                                        if (paraItem.都道府県CD != null && paraItem.都道府県CD.length > 0) {
                                            if (paraItem.市区町村CD == null || paraItem.市区町村CD.length == 0) {
                                                paraError.Field = "都道府県CD";     //フォーカスを移動したいフィールド
                                                paraError.Message = "都道府県CDを入力した場合は、市区町村CDを入力してください。";
                                                return;
                        }
                        }
                        }
                            ) == true) {

                            return;     //エラーの場合は終了
                        }

                        //API送信後サーバのチェックでエラーが発生した場合のサンプル
                        if (testFlag) {
                            let error = {
                                ErrorIdentity: this.bindItems[0]["IDENTITY_ID"],     //エラーフラグを付けるエラー行(本来はサーバ側でセット)
                                Field: '社員コード',
                                Message: '社員コードが重複しています。',
                            };

                            //エラー行を先頭に移動し、エラーメッセージを表示
                            Project.MoveErrorFocus(this.bindItems, error);

                            return;
                        }

                    } finally {
                        Project.SetLoading(false);  //２度押し防止用くるくる（終了）
                    }

                    Project.CloseDialog(this.bindItems[0]);
                }
                ,
                remove: function () {
                    if (confirm("表示されているデータを削除しますか？")) {
                        this.bindItems[0].DELETE_FLAG = true;

                        this.submit(false);
                    }

                }
                ,
                clear: function () {

                    //引数の取得（Project.OpenDialogでセット）
                    let args = Project.GetDialogArgs();

                    //新規データ
                    let newFlag = false;
                    if (args == null) {
                        args = {};

                        //デフォルト値
                        args.性別区分 = 2;  //女性
                        args.扶養家族区分= [];      //配列定義しないと全チェックになる
                        args.都道府県CD = '';
                        args.市区町村CD= '';      //こちら入れないと関連している項目が動作しない
                        args.町域CD= '';

                        newFlag = true;
                    }
                    args.NEW_FLAG = newFlag;

                    this.bindItems = [];
                    this.bindItems.push(args);
                }
                ,
                returnpage: function () {
                    //キャンセル（引数はなし(又はnull)で親側の画面の処理をしない）
                    Project.CloseDialog();
                }
                ,
                //市区町村の取得
                getShikuchoson: function (todofukenCD) {
                    if (todofukenCD == null || todofukenCD.length == 0) {
                        return [];
                    }

                    return this.shikuchosonItems.filter(
                        function (item) {
                            let findFlag = true;

                            if (findFlag == true && item.都道府県CD != todofukenCD) {
                                findFlag = false;
                            }

                            return findFlag;
                        }
                    );
                }
                ,
                //町域の取得
                getChoiki: function (todofukenCD, shikuchosonCD) {
                    if (todofukenCD == null || todofukenCD.length == 0) {
                        return [];
                    }

                    if (shikuchosonCD == null || shikuchosonCD.length == 0) {
                        return [];
                    }

                    return this.choikiItems.filter(
                        function (item) {
                            let findFlag = true;

                            if (findFlag == true && item.都道府県CD != todofukenCD) {
                                findFlag = false;
                            }

                            if (findFlag == true && item.市区町村CD != shikuchosonCD) {
                                findFlag = false;
                            }

                            return findFlag;
                        }
                    );

                }
                ,
                //都道府県変更時
                changeTodofuken: function (elem) {
                    elem.市区町村CD = '';
                    elem.町域CD = '';
                },
                //市区町村変更時
                changeShikuchoson: function (elem) {
                    elem.町域CD = '';
                },
            },
        });

    </script>
</body>
</html>